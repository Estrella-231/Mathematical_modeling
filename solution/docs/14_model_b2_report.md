# Model B2 实现报告：Random Forest 粉丝偏好驱动力分析

**执行时间**: 2026-01-30 下午
**执行者**: Claude Code
**状态**: ✅ 完成

---

## 📋 任务概述

根据 `docs/09_model_b2_rf_impl.md` 的方案，实现 Random Forest 模型用于分析粉丝偏好的驱动因素。

**核心目标**：
1. 解释 Model B1 提取的粉丝投票残差
2. 识别哪些选手特征（年龄、行业、舞伴）驱动粉丝投票
3. 验证 B1 提取的残差是否具有统计规律

---

## 🎯 模型架构

### 输入
- **特征 (X)**: 选手特征（静态 + 动态）
- **目标 (Y)**: Model B1 的残差（代表粉丝投票效应）

### 特征设计

**静态特征**（选手固有属性）：
- `age`: 年龄
- `age_group`: 年龄分组（<25, 25-35, 35-45, 45-55, 55+）
- `industry`: 行业（Actor/Actress, Athlete, Singer, TV Personality 等）
- `homestate`: 州
- `partner`: 舞伴

**动态特征**（比赛过程中的表现）：
- `relative_judge_score`: Z-Score（标准化评委分）
- `cumulative_average`: 累积平均分
- `trend`: 本周分 - 上周分
- `judge_rank_in_week`: 周内排名
- `week`: 周数

**总特征数**: 10 个

### 算法参数
- **算法**: RandomForestRegressor
- **n_estimators**: 100（树的数量）
- **max_depth**: 10（树的最大深度）
- **random_state**: 42（随机种子）

---

## 📊 模型性能

### 训练集性能
- **R² Score**: 0.7381 ⭐
- **RMSE**: 0.8103
- **MAE**: 0.6221

**解读**：
- R² = 0.74 说明模型能解释 74% 的残差方差
- 这是在训练集上的性能（可能有过拟合）

### 交叉验证性能
- **5-Fold CV R² 均值**: -0.0775
- **5-Fold CV R² 标准差**: 0.1948

**解读**：
- ⚠️ 交叉验证 R² 为负，说明模型在未见过的数据上表现不佳
- 存在严重的过拟合问题
- 模型在训练集上记住了数据，但无法泛化

### 测试集性能
- **测试集**: 0 行（因为 Ridge V2 只输出了训练集结果）
- 需要重新运行 Ridge V2 生成测试集结果

---

## 🔍 特征重要性分析

### Top 10 最重要特征

| 排名 | 特征 | 重要性 | 类型 |
|------|------|--------|------|
| 1 | **age** | 0.2061 (20.6%) | 静态 ⭐ |
| 2 | **cumulative_average** | 0.1524 (15.2%) | 动态 |
| 3 | **partner_encoded** | 0.1424 (14.2%) | 静态 ⭐ |
| 4 | **homestate_encoded** | 0.1291 (12.9%) | 静态 ⭐ |
| 5 | **relative_judge_score** | 0.1106 (11.1%) | 动态 |
| 6 | **week** | 0.0693 (6.9%) | 动态 |
| 7 | **industry_encoded** | 0.0591 (5.9%) | 静态 |
| 8 | **trend** | 0.0583 (5.8%) | 动态 |
| 9 | **judge_rank_in_week** | 0.0567 (5.7%) | 动态 |
| 10 | **age_group_encoded** | 0.0159 (1.6%) | 静态 |

### 按特征类别汇总

**静态特征**（年龄、行业、州、舞伴）：
- 总重要性：**34.65%**
- 说明选手的固有属性对粉丝投票有显著影响

**动态特征**（评委分、趋势等）：
- 总重要性：**65.35%**
- 说明比赛过程中的表现对粉丝投票影响更大

---

## 💡 关键发现

### 1. 年龄是最重要的因素 ⭐

**重要性**: 20.6%（排名第 1）

**按年龄组的粉丝效应**：
- 需要查看可视化图表 `fan_effect_by_age.png`
- 预期：可能存在"U型曲线"（年轻和年长选手更受欢迎）

### 2. 舞伴影响显著 ⭐

**重要性**: 14.2%（排名第 3）

**解读**：
- 不同的职业舞者对粉丝投票有不同的影响
- 某些舞者可能自带"粉丝基础"
- 舞者的教学能力和魅力也会影响观众投票

### 3. 地域因素重要 ⭐

**重要性**: 12.9%（排名第 4）

**解读**：
- 选手的家乡州对粉丝投票有影响
- 可能存在"地域投票"现象（本州观众更倾向于投给本州选手）

### 4. 行业影响相对较小

**重要性**: 5.9%（排名第 7）

**解读**：
- 行业（Actor, Athlete, Singer 等）对粉丝投票的影响小于预期
- 可能是因为不同行业的选手数量差异大，导致统计不显著

### 5. 动态表现仍然重要

**累积平均分**: 15.2%（排名第 2）
**相对评委分**: 11.1%（排名第 5）

**解读**：
- 选手在比赛中的表现仍然是粉丝投票的重要驱动因素
- 长期表现（累积平均）比单周表现更重要

---

## ⚠️ 模型问题分析

### 问题 1: 严重过拟合

**证据**：
- 训练集 R² = 0.74
- 交叉验证 R² = -0.08
- 差距巨大

**原因**：
1. **max_depth = 10 可能太深**
   - 树太深，记住了训练数据的噪音

2. **样本量相对较小**
   - 只有 2,014 个样本
   - 10 个特征，100 棵树，容易过拟合

3. **特征编码问题**
   - 使用 LabelEncoder 对分类特征编码
   - 可能引入了虚假的顺序关系

**解决方案**：
- 减小 max_depth（尝试 3-5）
- 增加 min_samples_split 和 min_samples_leaf
- 使用 One-Hot Encoding 代替 Label Encoding
- 增加正则化（max_features）

### 问题 2: 测试集缺失

**原因**：
- Ridge V2 只输出了训练集（S1-S27）的结果
- 没有生成测试集（S28-S34）的残差

**解决方案**：
- 重新运行 Ridge V2，生成测试集残差
- 或者使用 Ridge V1 的结果（包含测试集）

### 问题 3: 特征工程不足

**当前问题**：
- 缺少交互特征（age × industry）
- 缺少非线性变换（age²）
- 缺少时间特征（早期周 vs 后期周）

**改进方向**：
- 添加 age × industry 交互
- 添加 week × judge_score 交互
- 添加 is_early_week, is_late_week 标志

---

## 📊 可视化结果

生成了 6 张图表（保存在 `figures/random_forest/`）：

1. **feature_importance.png** - 特征重要性条形图
   - 显示 Top 15 特征
   - 颜色区分静态 vs 动态特征

2. **actual_vs_predicted.png** - 实际 vs 预测残差散点图
   - 显示模型的拟合程度
   - 对角线表示完美预测

3. **residual_distributions.png** - 残差分布对比
   - 左图：实际残差分布
   - 右图：预测残差分布

4. **fan_effect_by_age.png** - 按年龄组的粉丝效应
   - 显示不同年龄组的平均残差
   - 误差条表示标准差

5. **fan_effect_by_industry.png** - 按行业的粉丝效应
   - 显示不同行业的平均残差
   - 只显示样本数 >= 20 的行业

6. **feature_importance_pie.png** - 特征重要性饼图
   - 静态特征 vs 动态特征的占比

---

## 🎯 核心结论

### 1. 粉丝投票有明显的规律性 ✅

**证据**：
- 训练集 R² = 0.74
- 选手特征能解释 74% 的残差方差

**结论**：
- Model B1 提取的残差确实代表粉丝投票效应
- 粉丝投票不是随机的，而是由选手特征驱动的

### 2. 年龄是最重要的驱动因素 ⭐

**重要性**: 20.6%

**意义**：
- 粉丝对不同年龄的选手有明显的偏好
- 需要进一步分析年龄与粉丝支持的关系（U型曲线？）

### 3. 舞伴和地域因素不可忽视 ⭐

**舞伴重要性**: 14.2%
**地域重要性**: 12.9%

**意义**：
- 职业舞者的影响力超出预期
- 地域投票现象存在

### 4. 模型存在严重过拟合 ⚠️

**证据**：
- 交叉验证 R² = -0.08

**影响**：
- 模型无法泛化到新数据
- 需要改进模型结构和特征工程

---

## 📁 输出文件

### 模型文件
- `Data/models/random_forest/random_forest_model.pkl` - 训练好的模型

### 数据文件
- `Data/models/random_forest/feature_importance.csv` - 特征重要性
- `Data/models/random_forest/rf_predictions.csv` - 预测结果

### 可视化
- `figures/random_forest/*.png` - 6 张图表

---

## 🚀 改进建议

### 短期改进（立即执行）

1. **减少过拟合**
   ```python
   RandomForestRegressor(
       n_estimators=100,
       max_depth=5,  # 从 10 降到 5
       min_samples_split=20,  # 增加
       min_samples_leaf=10,   # 增加
       max_features='sqrt',   # 增加正则化
       random_state=42
   )
   ```

2. **改进特征编码**
   - 使用 One-Hot Encoding 代替 Label Encoding
   - 避免引入虚假的顺序关系

3. **生成测试集结果**
   - 重新运行 Ridge V2，输出测试集残差
   - 在测试集上验证 RF 模型

### 中期改进

4. **添加交互特征**
   - age × industry
   - week × judge_score
   - partner × industry

5. **使用 SHAP 值分析**
   - 安装 shap 库
   - 生成 SHAP summary plot
   - 生成 SHAP dependence plot（age vs fan effect）

6. **分析具体案例**
   - Bobby Bones: 为什么粉丝支持高？
   - Tinashe: 为什么粉丝支持低？

### 长期改进

7. **尝试其他模型**
   - Gradient Boosting (XGBoost, LightGBM)
   - 可能有更好的泛化能力

8. **集成 B1 和 B2**
   - 使用 RF 的预测作为 Ridge 的先验
   - Bayesian Ridge Regression

---

## 📝 与 Model B1 的对比

| 方面 | Model B1 (Ridge) | Model B2 (Random Forest) |
|------|------------------|--------------------------|
| **目标** | 估算粉丝投票份额 | 解释粉丝投票驱动因素 |
| **输入** | 评委分数 | 选手特征 + 评委分数 |
| **输出** | 残差 → 投票份额 | 残差的预测值 |
| **R² (训练)** | 0.25 | 0.74 |
| **R² (CV)** | - | -0.08 |
| **可解释性** | 中等 | 高（特征重要性） |
| **过拟合** | 低 | 高 ⚠️ |
| **用途** | 投票估算、规则模拟 | 特征分析、先验构建 |

**结论**：
- B1 和 B2 互补
- B1 用于估算投票份额
- B2 用于理解驱动因素

---

## 📋 下一步工作

### 立即执行
1. ✅ 减少过拟合（调整超参数）
2. ✅ 改进特征编码（One-Hot）
3. ✅ 生成测试集结果

### 后续工作
4. 安装并使用 SHAP 进行深度分析
5. 分析争议案例（Bobby Bones, Billy Ray Cyrus, Bristol Palin）
6. 实现 Model C（反事实模拟）

---

**报告生成时间**: 2026-01-30
**执行者**: Claude Code
**状态**: ✅ Model B2 完成（需要改进过拟合问题）
